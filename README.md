![bili-sync](https://socialify.git.ci/amtoaer/bili-sync/image?description=1&font=KoHo&issues=1&language=1&logo=data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAEOdJREFUeF7tXUtyGzkSBUryttU%2BQdMnsXQSS2trIjyt6LXsdYfGE2F5bfkklk8i9gl6NNuhChMoVlElssjKBBIFFPC4sUzi%2BzIfMgEkAK3wAQJAYC8CGtgAASCwHwEQBNoBBA4gAIJAPYAACAIdAAJuCMCCuOGGXIUgAIIUImh00w0BEMQNN%2BQqBAEQpBBBo5tuCIAgbrghVyEITE6Qvy%2F%2FPK1U9VYZtTBaL7QxC6XVohC80U0qAkYtbVKj9VIb0%2FytK%2FXzly9Xd9QiJNIFJ8jfHz4vqlX9zhJCaXUu0WiUUTACa%2BLcT0WWoAR5vLy5Vkp9LFic6HpIBCxZtLo7ub36FKqaIAQBMUKJC%2BUOIhCQKKIEse6UXplvWplTiBIITI6AUcv6VXX2%2Bt%2F%2FbOYsEh8xgrST7x8SjUIZQMAZAWGSiBAE5HAWJzKGQEDQ5fImCMgRQsIoUwiBj74TeC%2BCgBxCYkQxYRCw7pauL17f%2FnHvWoEzQdr9jQfXipEPCEyCgOecxJkg%2F7n81w%2BsVk0iYlTii4BRy5OvV29cinEiyH%2F%2FcXNujPrmUiHyAIEYCGitLlzCVJwI8vj%2B5gHxUzHEjDqdEXC0ImyCYJfcWUTIGBsBo%2B5Ovl5dcJrhQhDDqQBpgUAyCDhYERZBMPdIRtRoiCMCtarPOMu%2BLII8vr%2F5hpB1R8kgWxIIGKXvf739%2FYzaGB5BLm%2FgXlGRRbo0EWC6WWSCwL1KU95oFR8BjptFJgjcK74gkCNZBMgxWiBIsjJEw0IhwJmHkAmC0JJQ4kK5UyMQhCDYPZ9ajKgvGAKMiTrZgjxiBSuYvFDwxAiAIBMDjupmh8DJ7RXJOJAS2d7DgsxOB9DgAwiAIFAPIACCQAeAgBsCsCBuuCFXIQiAIIUIGt10QwAEccMNuQpBAAQpRNDophsCIIgbbodz9d%2BsmNv9w0Ytm7c25tbuEHJUSoEgksAatdSV%2BtS%2FFWPz7kn6zzvsRK7iknEQRI4eIwf9Uz4nM3buoeQLOGBBBChCjfpMkSRj5OjgKfWcDwgiQJD6uHpDfWsiqdGYcb1NqVfIgiC%2BBGEoma0qFb%2BeavX68JRoRUAQT4K4XFWZwmhMda368JR4Sz8I4kkQF0WzVcacj7iQOnabPcXknB0EcYZundFV2WzeGMeTXVyrDqKYpPYUk3N2EMQZunVGH4WL4WpxFhS2oYlBaE%2FxeGcHQbwhVMrVzZrabfGxdiXOP6x8QBABgijG2eWh6qYYmX0sXSx3UEI0vmWAIL4IPucnXzK2XeUUrpaPlUtq70ZOXqSSQBASTIREng9BBlZCd%2FJe%2FnlaqarYd%2B1BEILuk5N4PAQZbAPRw%2F2bwrKRsY2UEASRBt5HIQOM1j6u1RRzI2n4pcsDQaQRXa%2F9sp%2Fw6pohGs7h0Q6QYy0REESaIO1hqe1zIdRqeudHqFn2pquPq%2B%2FUIMp%2BIc2GYK2u8QArCLKrXK2CK6Xumx%2B1WnaJtFZ%2F2b%2BfTL35Th0fN3%2B7KKI3AyYswBJ3U91q1fx9pKvNd8ao35rfjWq%2BM1ovcjiVCAuyFupSaXXnOuJOqKezq8oS6%2BipPq2NfjdHwpRNEKPu6lfVp9xH%2F1RY1biP%2F6ut63aeSpvG2lEmQTyWY8cAxe%2FjCARb0h6vmp2iRII4b5qx0UWGvQjM5TKLogjisycAXQ%2BDQOqbkcUQBOQIo%2BASpaZMkiIIAnJIqHHYMtoJ%2FI%2FU9l6yJwjIEVaxJUtP8cRi3gTxCLWQFDzKoiMgGmpDr3ZvynwJ4hE0KIBrU8SL3Wf7RbsD3S%2B%2FvxtNrXeza70%2BE9%2Fs7lM%2BLyIA%2BhnaaID%2BV7H2hlJztbIliIRrZU1%2BpzTboRT2%2ByacwpjnEAz7pV6HWmTzeQ69sf19DrsxZv13G4rzIgzn%2BHjpQ7CUjvfmSRAP64FAPRlq2yO%2BlTbfn46qexeypBJNnCVBXC4nmNPurowKT1SKY9RCKhP2LAlC7VSnIimZ9InUdvJquC5vKnsjVF2azzvpzJWrVAQxucZGqJB7J1cKK1rZEYTrXqXi60bQ18mr5F49lIJlz44g1A51y7DVqn6YXFMKrpDjaqVg3an6NAsXiztCpWDCi%2BMK0wWObeGzIgjnsoQURqfiyNF2mDMXCXxf2KgIsiIIZ%2F6Rgn87Kp1ME8xJTlkRZE4jU6a6T%2BsWw82KbemLJUhs35amSXmm4swVQRBBHaCy3Vb5%2BP7mIbu4KUEsgxbFDAV6vLwxQdtzoHCqTs1iFYvamYYgEUGPJeyU6p2LrKjtTJ8gMxqVUlLUWG2hKl5sa09tZ%2FIEmZNfG0spU6qXs6ASc76YDUGwB5KS%2Bo%2B3BQQZx0g2BWfpMMAzA7Kdyb80TshJzIiHfCyIUuQL4VI5a9DeCTz9CcT1XcTT19vjPWezMOZuejYEmQXgRt3pSv3sn7JrdvRN9S70fbV2jmaO9UV3uu%2FFpdL22PDEhJmFvHJ6HyRZwAdIMeRABR0lCe6ntarNDezTkWUWFj8bC8LyaS9vrpVSH0N5%2Bq7nsYNsXjKXv9sYtbfKqPOgVoVA2k4%2BMePm8iHIcfWGejlAsEmf53MKgdpFHqm3B4yN%2B6fUqThZQJBQ4%2FNwudGWDVsX6pcvV3e%2BPQ60eOBMkH5%2FLFm0OrqWegRnLvtWRVoQkY0nT2sx2TyEMVJTCC5lVUAQCtqCaSaxIEYtXR%2FnpHQ1VHwYBxtKO7s0PneIgSAcpAXScpSAa0GaJVL19On17R%2Frhz0DfLhtYjZBxM3aV6eL%2BwWCMCXomzwEQaYghotyuWC1vQ%2FiUsZYntb9%2BkaZ0IMgY2gK%2Fy5NEI4AuV2R8uO59dr0tl9amfuQL%2FpSrCEH35iHpjBJH9Iy5t4BRVE3L7yGWDKlNGAgTSiyUG5oB0EcheaaTdSCCK78%2BExkXbFwyee6ubmvrrE9HRDERUoeeTgEIexYe01qW1K8DR1f5QHXwazd3Et5PGMwGjrDsNJwsQQkLUoQRwvSKEXoEA0BrKhF%2BFgVEGQPyqHW8seESp1M2XLGLAhnxWeqaNyx%2Fof%2BnbuiN4axDfU%2F%2BXr1htJuWBAKSiNpJAnSVnXQzdpEvypzKtD82RRBcb9Grcd6OY1MkGZQi3TJBlWvkj%2BTTu0IxYJstHUgnGQuk%2B7QjNvnfo1NznvYgiChhdQvPwhBugq6d%2FomPlQ0JX4%2BdTXLxdxzJLAgPpDz84pO0vnVIwcXAQZBMAfhgjuQnkMQyk6vQJNQxAEEsA8ysXqAIBMD7lkdCOIJIDc758htZAvy0cZBHT3Vp6ZW15TAPi4WY%2Bnt%2BX17cUS1qt%2FF2rcBQcakJPw7hyDklRbhNtpz8Ce3V5%2B6YknLoVtt6FaPjFG%2FOSr3yza8v7HRt%2BfyXR0pkbEZizPpAtKZA0GGbl4Z3VDrY7M1sXUh2PZqX6BjvuMSBUHGMZJMMQeCDF2PyrRmO5uXPgSz%2BLuQTERuIIgIjORCZkEQpdT2YgLZfdizLErOv0bSj2BkaRASMggSzcrh4jiCIIWT7HGzRucBhwYAkhUYIFjM%2FYUhsu6DGgQRUMJkb1YcmGT%2Fevv7Wf%2Fr0QNGhNGW4GrtWo%2FAF%2BiNiJV8pAAEKYggtqtDZN57nptADlvmQZINlBHZegy6e7AgAkQ4UMQsRqSm%2FUYt61fV2fZNkJsLHGxck1L39qLroQvpbLp9h5k2wZQtUPuuKYq8F8QiCMmFDKRb1Bi%2F5KN55%2BLT9uRIJvSOO7aqH%2FaRjKInzIk9pUh2mrm4xCAIW7SiGVgk2XaLOAe7ulanQI59buY%2BZGFBJHSO6Ks3%2FnpaL0yRSLK3zXvctSFIU%2Br3XJbl87Eg8yVIc1fVvpsbyRfLHbgreHPlUIyQkj2DHwgiYRUYZbCC39KyIM%2B9NGpptF5qY5btl%2FxnB7oylLlXpnlmjV8GA3fXpHOJvs7GgrAI8uHzorITXXyiIQCCTA0944SabVqsSwCmhiXV%2BqgjcyOr9zcPMY4F2Lqp7Ux%2FmRcESZULg%2B2iKh4IIiVWLkEijkpSXZ5zOSBIBOnNBfQI0KRVJXcwi3QnVl4uFsNfjG2209LWCK0BQSKAPnDW4lArEohFigNSArXOacWR6pWkP0m3BFH1GfWZNOZJvgTUKp8mgCCRZAmCRAKeXy0pvMYWG%2FMsSHZzkBlG9PJVK48cIEgMObJMd6rhJjGAm7hOzi56bFc4qzkIhyBYyZqYFV113BWsyPtVWRHE4c2Ja%2BuWRVKVUqslu1cpDGJ5EYS5kpWCAIpiCdN6NPKJuEmY4yTd9ok3QsW92aMofnBWGVNYwcqTIG6jFFytwFTlnEHvmhIzirdrQ3Yulu0Yd6RqTXlWL9QG1ndW8S7yiL3%2FkTVBuKtZHRibo6mJnsJjaWUKiQ8cAx5rXiqhQFlakOZKHF1fUMNOtoXVXm7w1ih9qgt7xXZMcUd%2FN%2BrO3udl3x%2FZvvdrNG8vQezJedYWpOkc4xKHMcF1hLFnvI3Wi%2BbBSvsp%2BVHP9cOm9w0MAoToyyAV65HnJP2ltrNWtMaIsmNpPnxeE2W1av490tWiedim%2B6wvTVCWVN1XG3JtvlinmfTTvdq7bltzQUTvoghL%2FPV3Wv3VtevJ1Et7m6P9v49lGOtnzDuwhtqWp4v1rKBertaYMEP9budCEmWHVGSJ9u0MOAmG%2F%2BRNkGb4VqwH60MIHmXSEEhhWXe7pfkTpOGIvt9%2BcoAmMqSaAgFrMfXKfEtxQaQIgjRCZlzROYVSoI41AqNvo0QGqhyCtCRRWt31X5qNjH%2FR1aeyGXhICGUR5BmJoKtbRWs9sfOprVbta3apBGlcLlgTojYLJWufb3g3pyMG5RKktxRsiVKr%2BqfrzruQ%2FmRbzByJ0QkDBOmrZbs7XOv6O8jix9cNKYw6n3PEAQiyTw%2Bed5ubtwJtMrubDOI8A7bZ0FytFpWq3q7XQfKKXwNBXAbKljw7YRpaLXfCM7ryJwjT4HZlZ8e%2BFzLTKPtW2EwXMtOEyxQShwaCcLVKOn0vLuqFt9fGSLlWtxPzZQsqRKldMRvKB4JIoomyskMABMlOpOiQJAIgiCSaKCs7BECQ7ESKDkkiAIJIoomyskMABMlOpOiQJAIgiCSaKCs7BECQ7ESKDkkiAIJIoomyskNAniCRr6vPTkLoUDwEGPcZkN8oTOlOo3jIouYcEODcZUAmSOwXgXIQDPqQCAKMywfpBMFzAolIF83wRiAEQdprOn94Nw4FAIHICHCebCBbkPYk2UPkvqF6IOCNAHUFy1ZEJohNjIm6t2xQQGwEGO4VmyBws2JLF%2FX7IsBxr%2FgE%2BfB5Ua1quFm%2BUkL%2BaAhw3Cs2QWyGOdyaFw19VJw6AuyLBVlzENv71O9cTV1CaF88BLjWw8mCwIrEEzBqdkeAO%2FfoamJbkM6KpHqtvTuEyJkrApzQkm0MnAgCVytXVcqwX4zAxKHeOxNkQxKsamWoVfl0yeUt937vvQiC%2BUg%2BipRjT3zJ4TxJ3wZzLm9C5KgE6NMwAhLkECMI5iRQ02QQsE%2Fy6fpC6jJybxerDwz2SJJRkzIb4jkhF5%2BkDxWYy%2FsRZWrYTHsd8FUxUQuyY01W9aye5ZqpepTb7IDE6EANRpCuAmtRjp7qU1Ort0qr83KliZ6LIGDU0r7fopW5n%2BJV4%2BAE2bYqG7LYh1y0XpT0aIuIgpRSSO8xI22MfZi1ecToly9Xd1NCMClBpuwY6gICEgiAIBIoooxsEQBBshUtOiaBAAgigSLKyBYBECRb0aJjEgiAIBIoooxsEQBBshUtOiaBAAgigSLKyBYBECRb0aJjEgiAIBIoooxsEfg%2F0X%2FObh5OLKAAAAAASUVORK5CYII%3D&name=1&owner=1&pattern=Signal&pulls=1&stargazers=1&theme=Light)

## 简介

为 NAS 用户编写的 BILIBILI 收藏夹同步工具，可方便导入 EMBY 等媒体库工具浏览。

> 经常在点进自己的收藏夹时看到一大堆失效视频，简直逼死强迫症。想到自己 NAS 还有多余的 20T 存储空间，于是简单写了一个小工具用来实时把收藏夹内容同步下载到 NAS 上。
> ![](asset/space.png)

骄傲地由 python 驱动！

~~之前基本没有用过 python 的 asyncio，拿这个小工具练练手！（不是~~

## 工作截图

![下载视频](asset/run.png)

![EMBY 识别](asset/emby.png)

## 配置文件

对于配置文件的前五项，请参考[凭据获取流程](https://nemo2011.github.io/bilibili-api/#/get-credential)。

```python
class Config(DataClassJsonMixin):
    sessdata: str = ""
    bili_jct: str = ""
    buvid3: str = ""
    dedeuserid: str = ""
    ac_time_value: str = ""
    interval: int = 20    # 任务执行的间隔时间
    favorite_ids: list[int] = field(default_factory=list)  # 收藏夹的 id
    path_mapper: dict[int, str] = field(default_factory=dict)  # 收藏夹的 id 到存储目录的映射
```

程序默认会将配置文件存储于 `${程序路径}/config/config.json`，数据库文件存储于 `${程序路径}/data/data.db`，如果发现不存在则新建并写入初始配置。

配置文件加载时会校验内容是否为空，对于默认的空配置，校验将会报错，程序将会终止运行。

即：我们可以通过运行一次程序，等程序写入初始配置并提示配置错误终止后编辑 `config.json` 文件，编辑后即可重新运行。


## Docker 运行示例

docker compose 文件：
```yaml
services:
  bili-sync:
    image: amtoaer/bili-sync:latest
    user: 1000:1000  # 此处可以指定以哪个用户的权限运行，不填写的话默认 root，推荐填写。
    tty: true  # 加上这一行可以让日志变成彩色
    volumes:
      - /home/amtoaer/Videos/Bilibilis/:/Videos/Bilibilis/  # 视频文件
      - /home/amtoaer/.config/nas/bili-sync/config/:/app/config/  # 配置文件
      - /home/amtoaer/.config/nas/bili-sync/data/:/app/data/  # 数据库
      # 注：如需在 emby 内查看 up 主头像，需要将 emby 的 metadata/people/ 配置目录挂载至容器的 /app/thumb/
      - /home/amtoaer/.config/nas/emby/metadata/people/:/app/thumb/
    environment:
      - TZ=Asia/Shanghai
    restart: always
    network_mode: bridge
    hostname: bili-sync
    container_name: bili-sync
    logging:
      driver: "local"
```

对应的配置文件：

```json
{
    "sessdata": "xxxxxxxxxxxxxxxxxx",
    "bili_jct": "xxxxxxxxxxxxxxxxxx",
    "buvid3": "xxxxxxxxxxxxxxxxxx",
    "dedeuserid": "xxxxxxxxxxxxxxxxxx",
    "ac_time_value": "xxxxxxxxxxxxxxxxxx",
    "interval": 20,
    "favorite_ids": [
        711322958
    ],
    "path_mapper": {
        "711322958": "/Videos/Bilibilis/Bilibili-711322958/"
    }
}
```

## 支持的额外命令

为满足需要，该应用包含几个单独的命令，可在程序目录下使用 `python entry.py ${command name}` 运行。

1. `once` 

    处理收藏夹，和一般定时任务触发时执行的操作完全相同，但仅运行一次。
2. `recheck` 

    将本地不存在的视频文件标记成未下载，下次定时任务触发时将一并下载。
3. `upper_thumb`

    手动触发全量下载 up 主头像，为使用老版本时下载的没有 up 头像的视频添加头像。

## 路线图

- [x] 凭证认证
- [x] 视频选优
- [x] 视频下载
- [x] 支持并行下载
- [x] 支持作为 daemon 运行
- [x] 构建 nfo 和 poster 文件，方便以单集形式导入 emby
- [x] 支持收藏夹翻页，下载全部历史视频
- [x] 对接数据库，提前检查，按需下载
- [x] 提供简单易用的打包（如 docker）
